(function(){"use strict";function v(){return typeof process<"u"&&process.versions?.node!==void 0}const F=new Map;function d(e,t){const a=t?new Date(t):new Date;a.setFullYear(a.getFullYear()-e);const r=String(a.getDate()).padStart(2,"0"),o=String(a.getMonth()+1).padStart(2,"0"),n=a.getFullYear();return`${r}-${o}-${n}`}function P(e){if(e.length===0)return 0;const t=e.reduce((a,r)=>a+r,0);return l((t/e.length).toString())}class h{constructor(){this.enabled=!0}static getInstance(){return h.instance||(h.instance=new h),h.instance}log(t,a){this.enabled&&console.log(`[EconomicIndices] ${t}`,a||"")}error(t,a){this.enabled&&(new Date().toISOString(),console.error(`[EconomicIndices] ERROR: ${t}`,a||""))}enable(){this.enabled=!0}disable(){this.enabled=!1}}async function N(e,t,a={retries:3,retryDelay:1e3,timeout:8e3}){const r=F.get(e);if(r&&Date.now()-r.timestamp<U)return console.log(`[Cache hit] ${e}`),r.data;let o;for(let n=1;n<=a.retries;n++)try{const c=new AbortController,s=setTimeout(()=>c.abort(),a.timeout),i=await fetch(e,{signal:c.signal});if(clearTimeout(s),!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const u=await t(i);return F.set(e,{data:u,timestamp:Date.now()}),u}catch(c){o=c,n<a.retries&&await new Promise(s=>setTimeout(s,a.retryDelay))}throw o||new Error(`Failed after ${a.retries} retries`)}function m(e){return l((Math.pow(1+e/100,252)-1)*100+"")}function l(e){return parseFloat(parseFloat(`${e}`.replace(",",".")).toFixed(2))}function w(e){const t=new Date;return t.setFullYear(t.getFullYear()-e),`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}const y=h.getInstance();async function f(e){const{url:t,p:a,fb:r,iname:o,fOpt:n=K,hCfg:c}=e;try{y.log(`> '${o}'`,t);const s=await N(t,async g=>{if(!g.ok)throw new Error(`HTTP error! status: ${g.status}`);const C=await g.json(),E=a(C);if(E==null)throw new Error(`Invalid ${o} data structure`);return E},n);let i=[],u;if(c)try{u=c.urlBuilder(t),i=await N(u,async g=>{const C=await g.json();return c.p(C)},{...n,timeout:15e3})}catch(g){y.error(`Failed to fetch historical ${o} data`,g)}const $=O(s,i);return $.src=[t],u&&$.src.push(u),$}catch(s){return y.error(`Failed to fetch ${o} data:`,s),r??B()}}function O(e,t=[]){const a=typeof e=="number"?{current:e}:e,r=t.length>0?k(t):"avg"in a?a.avg:void 0;return{...a,avg:r,updated:new Date}}function k(e){return parseFloat((e.reduce((t,a)=>t+a,0)/e.length).toFixed(2))}function B(){return{current:0,updated:new Date}}async function W(e){return f({url:"https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados/ultimos/1?formato=json",p:t=>{if(!Array.isArray(t)||t.length===0)return null;const a=l(t[0].valor);return m(a)},fb:e?{...e,current:e.current?m(e.current):0}:void 0,iname:"CDI",hCfg:{urlBuilder:t=>t.replace("/ultimos/1","")+"&dataInicial="+d(5),p:t=>Array.isArray(t)?t.map(a=>{const r=l(a.valor);return m(r)}):[]}})}function j(e){return e.length===0?0:(e.reduce((t,a)=>t*(1+a/100),1)-1)*100}async function X(e){const t=w(5),a=w(1);return f({url:`https://apisidra.ibge.gov.br/values/t/1737/n1/all/v/63/p/${t}-${a}?formato=json`,p:r=>{if(!Array.isArray(r)||r.length<13)return null;const o=r.slice(-12).map(n=>l(n.V));return parseFloat(j(o).toFixed(2))},fb:e,iname:"INPC",hCfg:{urlBuilder:()=>`https://apisidra.ibge.gov.br/values/t/1737/n1/all/v/63/p/${t}-${a}?formato=json`,p:r=>{if(!Array.isArray(r)||r.length<2)return[];const o=r.slice(1),n=[],c={};return o.forEach(s=>{const i=s.D4N.split(" ")[1],u=l(s.V);c[i]||(c[i]=[]),c[i].push(u)}),Object.keys(c).forEach(s=>{const i=c[s];i.length===12&&n.push(j(i))}),n}}})}function S(e,t){return(e-t)/t*100}async function R(e){const t=w(5),a=w(1);return f({url:"https://servicodados.ibge.gov.br/api/v3/agregados/1737/periodos/-12/variaveis/2266?localidades=N1[all]",p:r=>{const o=r?.[0]?.resultados?.[0]?.series?.[0]?.serie;if(!o||Object.keys(o).length<12)return null;const n=Object.keys(o).sort(),c=n[0],s=n[n.length-1],i=l(o[c]),u=l(o[s]);return l(S(u,i))},fb:e,iname:"IPCA",hCfg:{urlBuilder:()=>`https://servicodados.ibge.gov.br/api/v3/agregados/1737/periodos/${t}-${a}/variaveis/2266?localidades=N1[all]`,p:r=>{const o=r?.[0]?.resultados?.[0]?.series?.[0]?.serie;if(!o)return[];const n=Object.keys(o).sort(),c=[];for(let s=12;s<n.length;s+=12){const i=l(o[n[s]]),u=l(o[n[s-12]]);c.push(S(i,u))}return c}}})}async function Y(e){const t=`https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados?formato=json&dataInicial=${d(5)}`;return f({url:"https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados/ultimos/1?formato=json",p:a=>a?.length?l(a[0].valor):null,fb:e,iname:"SELIC",hCfg:{urlBuilder:()=>t,p:a=>Array.isArray(a)?a.map(r=>l(r.valor)):[]}})}const p=h.getInstance();function b(e){return d(0,e)}function M(){const e=new Date;return e.setDate(e.getDate()-1),e.getDay()===0?e.setDate(e.getDate()-2):e.getDay()===6&&e.setDate(e.getDate()-1),e}async function V(e){const t=M(),a=new Date(d(5));try{return p.log("Iniciando busca por cotação PTAX do dólar (dia útil anterior)"),await f({url:`https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarDia(dataCotacao=@dataCotacao)?@dataCotacao='${b(t)}'&$top=1&$format=json`,p:r=>{if(!r.value||r.value.length===0)return p.log("Nenhum dado encontrado na API do BCB para o dia útil anterior"),null;const o=r.value[0],n=l(o.cotacaoCompra);return p.log(`Cotação PTAX encontrada para ${b(t)}: ${n}`),n},fb:e,iname:"Dólar (PTAX)",hCfg:{urlBuilder:()=>{const r=b(t),o=`https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarPeriodo(dataInicial=@dataInicial,dataFinalCotacao=@dataFinalCotacao)?@dataInicial='${b(a)}'&@dataFinalCotacao='${r}'&$top=10000&$format=json`;return p.log(`Buscando dados históricos PTAX: ${o}`),o},p:r=>{if(!r.value||r.value.length===0)return p.log("Nenhum dado histórico PTAX encontrado"),[];const o=r.value.filter(s=>{const i=new Date(s.dataHoraCotacao);return i.getDay()!==0&&i.getDay()!==6}),n=[],c={};return o.forEach(s=>{const i=new Date(s.dataHoraCotacao).getFullYear(),u=l(s.cotacaoCompra);c[i]||(c[i]=[]),c[i].push(u)}),Object.keys(c).forEach(s=>{const i=parseInt(s);if(i>=a.getFullYear()){const u=P(c[i]);n.push(u),p.log(`Média anual PTAX ${s}: ${u}`)}}),n}}})}catch(r){throw p.error("Erro ao buscar cotação PTAX do dólar",r),r}}const x=h.getInstance();async function z(e){const t=new Date,a=new Date(d(5));return f({url:"https://olinda.bcb.gov.br/olinda/servico/IndiceRisk/versao/v1/odata/UltimoValor?$format=json",p:r=>{if(!r?.value?.[0]?.pontos)return null;const o=l(r.value[0].pontos);return x.log(`EMBI+ atual: ${o} pontos`),o},fb:e,iname:"EMBI+",hCfg:{urlBuilder:()=>`https://olinda.bcb.gov.br/olinda/servico/IndiceRisk/versao/v1/odata/ValoresSeries?$format=json&dataInicial=${d(0,a)}&dataFinal=${d(0,t)}`,p:r=>r?.value?r.value.map(o=>l(o.pontos)):[]}})}const G=h.getInstance();async function Z(e){const t=new Date,a=new Date(d(5));return f({url:`https://api.fgv.br/igpm/ultimo?data=${d(0,t)}`,p:r=>{if(!r?.valor)return null;const o=l(r.valor);return G.log(`IGPM atual: ${o}%`),o},fb:e,iname:"IGPM",hCfg:{urlBuilder:()=>`https://api.fgv.br/igpm/serie?inicio=${d(0,a)}&fim=${d(0,t)}`,p:r=>Array.isArray(r)?r.map(o=>l(o.valor)):[]}})}const H=h.getInstance();async function J(e){const t=new Date,a=new Date(d(5));return f({url:"https://olinda.bcb.gov.br/olinda/servico/taxaReferencial/versao/v1/odata/UltimoValor?$format=json",p:r=>{if(!r?.value?.[0]?.taxa)return null;const o=l(r.value[0].taxa);return H.log(`TR atual: ${o}%`),o},fb:e,iname:"TR",hCfg:{urlBuilder:()=>`https://olinda.bcb.gov.br/olinda/servico/taxaReferencial/versao/v1/odata/ValoresSeries?$format=json&dataInicial=${d(0,a)}&dataFinal=${d(0,t)}`,p:r=>r?.value?r.value.map(o=>l(o.taxa)):[]}})}const U=30*60*1e3,K={retries:7,retryDelay:1500,timeout:1e3},L={Selic:Y,CDI:W,ipca:R,inpc:X,dolar:V,igpm:Z,tr:J,embi:z},I="economic_indices_data";async function D(){const{default:e}=await import("fs/promises"),{default:t}=await import("path");return{fs:e,path:t}}function Q(e){let t=new Date(0);return Object.values(e).forEach(a=>{a?.updated instanceof Date&&a.updated>t&&(t=a.updated)}),t}async function _(){try{if(typeof window<"u"&&window.localStorage){const e=localStorage.getItem(I);return e?JSON.parse(e):null}else if(v()){const{fs:e,path:t}=await D(),a=t.join(process.cwd(),"indices.json");try{const r=await e.readFile(a,"utf-8");return JSON.parse(r)}catch(r){if(r.code==="ENOENT")return null;throw r}}return null}catch(e){return console.error("Failed to load from storage:",e),null}}async function T(e){try{const t=Q(e),a={indices:e,updated:t.toISOString()};if(typeof window<"u"&&window.localStorage)localStorage.setItem(I,JSON.stringify(a));else if(v()){const{fs:r,path:o}=await D();console.log(process.cwd());const n=o.join(process.cwd(),"indices.json");await r.writeFile(n,JSON.stringify(a,null,2))}}catch(t){console.error("Failed to save to storage:",t)}}function q(e){if(!e)return!0;const t=new Date(e.updated),a=new Date;return t.getDate()!==a.getDate()||t.getMonth()!==a.getMonth()||t.getFullYear()!==a.getFullYear()}async function tt(){try{if(typeof window<"u"&&window.localStorage)localStorage.removeItem(I);else if(v()){const{fs:e,path:t}=await D(),a=t.join(process.cwd(),"indices.json");try{await e.unlink(a)}catch(r){if(r.code!=="ENOENT")throw r}}}catch(e){throw console.error("Failed to clear storage:",e),e}}const et="data:text/javascript;base64,aW1wb3J0e0VDT05JRFggYXMgb31mcm9tIi4vRWNvbm9taWNJbmRpY2VzQ2xpZW50LmpzIjtpbXBvcnR7bG9hZEZyb21TdG9yYWdlIGFzIHMsZGV2ZXJpYUF0dWFsaXphciBhcyBhfWZyb20iLi9zdG9yYWdlLmpzIjtzZWxmLmE9YXN5bmMgcj0+e2lmKHIudC5lPT09InVwZGF0ZSIpdHJ5e2NvbnN0IGU9YXdhaXQgby5vKCk7c2VsZi5yKHtlOiJpbmRpY2VzIixzOmV9KX1jYXRjaChlKXtzZWxmLnIoe2U6ImVycm9yIixpOmUgaW5zdGFuY2VvZiBFcnJvcj9lLm46IlVua25vd24gZXJyb3IifSl9fTsoYXN5bmMoKT0+e2NvbnN0IHI9YXdhaXQgcygpO2lmKCFyfHxhKHIpKXtjb25zdCBlPWF3YWl0IG8ubygpO2UmJnNlbGYucih7ZToiaW5kaWNlcyIsczplfSl9fSkoKTsK";class at{constructor(){this.worker=null,this.currentIndices=null,this.pendingResolvers=[],this.isNode=typeof process<"u"&&process.versions?.node!==void 0,this.initialize().catch(console.error)}async initialize(){this.isNode||await this.initWebWorker()}async initWebWorker(){if(!(typeof Worker>"u"))try{const t=new Blob([et],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(t)),this.worker.onmessage=a=>{a.data.type==="indices"&&this.handleNewIndices(a.data.indices)},this.worker.onerror=a=>{console.error("Worker error:",a),this.handleWorkerError()}}catch(t){console.error("Worker initialization failed:",t)}}handleNewIndices(t){this.currentIndices=t,t&&T(t).catch(console.error),this.resolvePendingPromises(t)}handleWorkerError(){this.resolvePendingPromises(null)}resolvePendingPromises(t){this.pendingResolvers.forEach(a=>a(t)),this.pendingResolvers=[]}async getIndices(){const t=await _();return t&&!q(t)?t.indices:this.isNode?this.fetchIndicesNode():this.fetchIndicesBrowser()}async fetchIndicesNode(){try{const t=await this.fetchAll(this.currentIndices);return t&&(await T(t),this.currentIndices=t),t}catch(t){return console.error("Node fetch failed:",t),null}}async fetchIndicesBrowser(){return this.worker?new Promise(t=>{this.pendingResolvers.push(t),this.worker?.postMessage({type:"update"})}):this.fetchIndicesNode()}async fetchAll(t){const a={};return await Promise.all(Object.entries(L).map(async([r,o])=>{const n=r;a[n]=await o(t?.[n])})),a}}const A=new at;typeof window<"u"&&(window.ECONIDX=A,window.clearIndices=async()=>{await tt().catch(e=>{console.error("Erro ao limpar storage:",e)})}),v()&&A.getIndices()})();
