(function(){"use strict";function f(){return typeof process<"u"&&process.versions?.node!==void 0}const F=new Map;function m(e){const t=new Date;t.setFullYear(t.getFullYear()-e);const r=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=t.getFullYear();return`${r}/${a}/${o}`}function A(e){if(e.length===0)return 0;const t=e.reduce((r,a)=>r+a,0);return u((t/e.length).toString())}class d{constructor(){this.enabled=!0}static getInstance(){return d.instance||(d.instance=new d),d.instance}log(t,r){this.enabled&&console.log(`[EconomicIndices] ${t}`,r||"")}error(t,r){this.enabled&&(new Date().toISOString(),console.error(`[EconomicIndices] ERROR: ${t}`,r||""))}enable(){this.enabled=!0}disable(){this.enabled=!1}}async function $(e,t,r={retries:3,retryDelay:1e3,timeout:8e3}){const a=F.get(e);if(a&&Date.now()-a.timestamp<z)return console.log(`[Cache hit] ${e}`),a.data;let o;for(let n=1;n<=r.retries;n++)try{const c=new AbortController,s=setTimeout(()=>c.abort(),r.timeout),i=await fetch(e,{signal:c.signal});if(clearTimeout(s),!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const l=await t(i);return F.set(e,{data:l,timestamp:Date.now()}),l}catch(c){o=c,n<r.retries&&await new Promise(s=>setTimeout(s,r.retryDelay))}throw o||new Error(`Failed after ${r.retries} retries`)}function b(e){return u((Math.pow(1+e/100,252)-1)*100+"")}function u(e){return parseFloat(parseFloat(`${e}`.replace(",",".")).toFixed(2))}function g(e){const t=new Date;return t.setFullYear(t.getFullYear()-e),`${t.getFullYear()}${String(t.getMonth()+1).padStart(2,"0")}`}const v=d.getInstance();async function p(e){const{url:t,p:r,fb:a,iname:o,fOpt:n=V,hCfg:c}=e;try{v.log(`> '${o}'`,t);const s=await $(t,async l=>{if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const C=await l.json(),y=r(C);if(y==null)throw new Error(`Invalid ${o} data structure`);return y},n);let i=[];if(c)try{const l=c.urlBuilder(t);i=await $(l,async C=>{const y=await C.json();return c.p(y)},{...n,timeout:15e3})}catch(l){v.error(`Failed to fetch historical ${o} data`,l)}return E(s,i)}catch(s){return v.error(`Failed to fetch ${o} data:`,s),a??O()}}function E(e,t=[]){const r=typeof e=="number"?{current:e}:e,a=t.length>0?P(t):"avg"in r?r.avg:void 0;return{...r,avg:a,updated:new Date}}function P(e){return parseFloat((e.reduce((t,r)=>t+r,0)/e.length).toFixed(2))}function O(){return{current:0,updated:new Date}}async function W(e){return p({url:"https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados/ultimos/1?formato=json",p:t=>{if(!Array.isArray(t)||t.length===0)return null;const r=u(t[0].valor);return b(r)},fb:e?{...e,current:e.current?b(e.current):0}:void 0,iname:"CDI",hCfg:{urlBuilder:t=>t.replace("/ultimos/1","")+"&dataInicial="+m(5),p:t=>Array.isArray(t)?t.map(r=>{const a=u(r.valor);return b(a)}):[]}})}function N(e){return e.length===0?0:(e.reduce((t,r)=>t*(1+r/100),1)-1)*100}async function X(e){const t=g(5),r=g(1);return p({url:`https://apisidra.ibge.gov.br/values/t/1737/n1/all/v/63/p/${t}-${r}?formato=json`,p:a=>{if(!Array.isArray(a)||a.length<13)return null;const o=a.slice(-12).map(n=>u(n.V));return parseFloat(N(o).toFixed(2))},fb:e,iname:"INPC",hCfg:{urlBuilder:()=>`https://apisidra.ibge.gov.br/values/t/1737/n1/all/v/63/p/${t}-${r}?formato=json`,p:a=>{if(!Array.isArray(a)||a.length<2)return[];const o=a.slice(1),n=[],c={};return o.forEach(s=>{const i=s.D4N.split(" ")[1],l=u(s.V);c[i]||(c[i]=[]),c[i].push(l)}),Object.keys(c).forEach(s=>{const i=c[s];i.length===12&&n.push(N(i))}),n}}})}function S(e,t){return(e-t)/t*100}async function k(e){const t=g(5),r=g(1);return p({url:"https://servicodados.ibge.gov.br/api/v3/agregados/1737/periodos/-12/variaveis/2266?localidades=N1[all]",p:a=>{const o=a?.[0]?.resultados?.[0]?.series?.[0]?.serie;if(!o||Object.keys(o).length<12)return null;const n=Object.keys(o).sort(),c=n[0],s=n[n.length-1],i=u(o[c]),l=u(o[s]);return u(S(l,i))},fb:e,iname:"IPCA",hCfg:{urlBuilder:()=>`https://servicodados.ibge.gov.br/api/v3/agregados/1737/periodos/${t}-${r}/variaveis/2266?localidades=N1[all]`,p:a=>{const o=a?.[0]?.resultados?.[0]?.series?.[0]?.serie;if(!o)return[];const n=Object.keys(o).sort(),c=[];for(let s=12;s<n.length;s+=12){const i=u(o[n[s]]),l=u(o[n[s-12]]);c.push(S(i,l))}return c}}})}async function Y(e){const t=`https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados?formato=json&dataInicial=${m(5)}`;return p({url:"https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados/ultimos/1?formato=json",p:r=>r?.length?u(r[0].valor):null,fb:e,iname:"SELIC",hCfg:{urlBuilder:()=>t,p:r=>Array.isArray(r)?r.map(a=>u(a.valor)):[]}})}const h=d.getInstance();function w(e){const t=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0"),a=e.getFullYear();return`${t}-${r}-${a}`}function B(){const e=new Date;return e.setDate(e.getDate()-1),e.getDay()===0?e.setDate(e.getDate()-2):e.getDay()===6&&e.setDate(e.getDate()-1),e}async function R(e){const t=B(),r=new Date(m(5));try{return h.log("Iniciando busca por cotação PTAX do dólar (dia útil anterior)"),await p({url:`https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarDia(dataCotacao=@dataCotacao)?@dataCotacao='${w(t)}'&$top=1&$format=json`,p:a=>{if(!a.value||a.value.length===0)return h.log("Nenhum dado encontrado na API do BCB para o dia útil anterior"),null;const o=a.value[0],n=u(o.cotacaoCompra);return h.log(`Cotação PTAX encontrada para ${w(t)}: ${n}`),n},fb:e,iname:"Dólar (PTAX)",hCfg:{urlBuilder:()=>{const a=w(t),o=`https://olinda.bcb.gov.br/olinda/servico/PTAX/versao/v1/odata/CotacaoDolarPeriodo(dataInicial=@dataInicial,dataFinalCotacao=@dataFinalCotacao)?@dataInicial='${w(r)}'&@dataFinalCotacao='${a}'&$top=10000&$format=json`;return h.log(`Buscando dados históricos PTAX: ${o}`),o},p:a=>{if(!a.value||a.value.length===0)return h.log("Nenhum dado histórico PTAX encontrado"),[];const o=a.value.filter(s=>{const i=new Date(s.dataHoraCotacao);return i.getDay()!==0&&i.getDay()!==6}),n=[],c={};return o.forEach(s=>{const i=new Date(s.dataHoraCotacao).getFullYear(),l=u(s.cotacaoCompra);c[i]||(c[i]=[]),c[i].push(l)}),Object.keys(c).forEach(s=>{const i=parseInt(s);if(i>=r.getFullYear()){const l=A(c[i]);n.push(l),h.log(`Média anual PTAX ${s}: ${l}`)}}),n}}})}catch(a){throw h.error("Erro ao buscar cotação PTAX do dólar",a),a}}const z=30*60*1e3,V={retries:7,retryDelay:1500,timeout:1e3},Z={Selic:Y,CDI:W,ipca:k,inpc:X,dolar:R},I="economic_indices_data";async function D(){const{default:e}=await import("fs/promises"),{default:t}=await import("path");return{fs:e,path:t}}function H(e){let t=new Date(0);return Object.values(e).forEach(r=>{r?.updated instanceof Date&&r.updated>t&&(t=r.updated)}),t}async function J(){try{if(typeof window<"u"&&window.localStorage){const e=localStorage.getItem(I);return e?JSON.parse(e):null}else if(f()){const{fs:e,path:t}=await D(),r=t.join(process.cwd(),"indices.json");try{const a=await e.readFile(r,"utf-8");return JSON.parse(a)}catch(a){if(a.code==="ENOENT")return null;throw a}}return null}catch(e){return console.error("Failed to load from storage:",e),null}}async function j(e){try{const t=H(e),r={indices:e,updated:t.toISOString()};if(typeof window<"u"&&window.localStorage)localStorage.setItem(I,JSON.stringify(r));else if(f()){const{fs:a,path:o}=await D();console.log(process.cwd());const n=o.join(process.cwd(),"indices.json");await a.writeFile(n,JSON.stringify(r,null,2))}}catch(t){console.error("Failed to save to storage:",t)}}function M(e){if(!e)return!0;const t=new Date(e.updated),r=new Date;return t.getDate()!==r.getDate()||t.getMonth()!==r.getMonth()||t.getFullYear()!==r.getFullYear()}async function x(){try{if(typeof window<"u"&&window.localStorage)localStorage.removeItem(I);else if(f()){const{fs:e,path:t}=await D(),r=t.join(process.cwd(),"indices.json");try{await e.unlink(r)}catch(a){if(a.code!=="ENOENT")throw a}}}catch(e){throw console.error("Failed to clear storage:",e),e}}const G="data:text/javascript;base64,aW1wb3J0e0VDT05JRFggYXMgb31mcm9tIi4vRWNvbm9taWNJbmRpY2VzQ2xpZW50LmpzIjtpbXBvcnR7bG9hZEZyb21TdG9yYWdlIGFzIHMsZGV2ZXJpYUF0dWFsaXphciBhcyBhfWZyb20iLi9zdG9yYWdlLmpzIjtzZWxmLmE9YXN5bmMgcj0+e2lmKHIudC5lPT09InVwZGF0ZSIpdHJ5e2NvbnN0IGU9YXdhaXQgby5vKCk7c2VsZi5yKHtlOiJpbmRpY2VzIixzOmV9KX1jYXRjaChlKXtzZWxmLnIoe2U6ImVycm9yIixpOmUgaW5zdGFuY2VvZiBFcnJvcj9lLm46IlVua25vd24gZXJyb3IifSl9fTsoYXN5bmMoKT0+e2NvbnN0IHI9YXdhaXQgcygpO2lmKCFyfHxhKHIpKXtjb25zdCBlPWF3YWl0IG8ubygpO2UmJnNlbGYucih7ZToiaW5kaWNlcyIsczplfSl9fSkoKTsK";class K{constructor(){this.worker=null,this.currentIndices=null,this.pendingResolvers=[],this.isNode=typeof process<"u"&&process.versions?.node!==void 0,this.initialize().catch(console.error)}async initialize(){this.isNode||await this.initWebWorker()}async initWebWorker(){if(!(typeof Worker>"u"))try{const t=new Blob([G],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(t)),this.worker.onmessage=r=>{r.data.type==="indices"&&this.handleNewIndices(r.data.indices)},this.worker.onerror=r=>{console.error("Worker error:",r),this.handleWorkerError()}}catch(t){console.error("Worker initialization failed:",t)}}handleNewIndices(t){this.currentIndices=t,t&&j(t).catch(console.error),this.resolvePendingPromises(t)}handleWorkerError(){this.resolvePendingPromises(null)}resolvePendingPromises(t){this.pendingResolvers.forEach(r=>r(t)),this.pendingResolvers=[]}async getIndices(){const t=await J();return t&&!M(t)?t.indices:this.isNode?this.fetchIndicesNode():this.fetchIndicesBrowser()}async fetchIndicesNode(){try{const t=await this.fetchAll(this.currentIndices);return t&&(await j(t),this.currentIndices=t),t}catch(t){return console.error("Node fetch failed:",t),null}}async fetchIndicesBrowser(){return this.worker?new Promise(t=>{this.pendingResolvers.push(t),this.worker?.postMessage({type:"update"})}):this.fetchIndicesNode()}async fetchAll(t){const r={};return await Promise.all(Object.entries(Z).map(async([a,o])=>{const n=a;r[n]=await o(t?.[n])})),r}}const T=new K;typeof window<"u"&&(window.ECONIDX=T,window.clearIndices=async()=>{await x().catch(e=>{console.error("Erro ao limpar storage:",e)})}),f()&&T.getIndices()})();
