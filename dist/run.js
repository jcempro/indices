(function(){"use strict";function f(){return typeof process<"u"&&process.versions?.node!==void 0}const b=new Map;function w(r){return S(0,r)}function S(r,e){const t=e?new Date(e):new Date;t.setFullYear(t.getFullYear()-r);const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=t.getFullYear();return`${n}-${a}-${o}`}class d{constructor(){this.enabled=!0}static getInstance(){return d.instance||(d.instance=new d),d.instance}log(e,t){this.enabled&&console.log(`[EconomicIndices] ${e}`,t||"")}error(e,t){this.enabled&&(new Date().toISOString(),console.error(`[EconomicIndices] ERROR: ${e}`,t||""))}enable(){this.enabled=!0}disable(){this.enabled=!1}}async function F(r,e,t={retries:3,retryDelay:1e3,timeout:8e3}){const n=b.get(r);if(n&&Date.now()-n.timestamp<E)return console.log(`[Cache hit] ${r}`),n.data;let a;for(let o=1;o<=t.retries;o++)try{const i=new AbortController,s=setTimeout(()=>i.abort(),t.timeout),l=await fetch(r,{signal:i.signal});if(clearTimeout(s),!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const c=await e(l);return b.set(r,{data:c,timestamp:Date.now()}),c}catch(i){a=i,o<t.retries&&await new Promise(s=>setTimeout(s,t.retryDelay))}throw a||new Error(`Failed after ${t.retries} retries`)}function p(r){return parseFloat(parseFloat(`${r}`.replace(",",".")).toFixed(2))}const g=d.getInstance();async function W(r){const{url:e,p:t,fb:n,iname:a,fOpt:o=k,hCfg:i}=r;try{g.log(`> '${a}'`,e);const s=await F(e,async u=>{if(!u.ok)throw new Error(`HTTP error! status: ${u.status}`);const I=await u.json(),D=t(I);if(D==null)throw new Error(`Invalid ${a} data structure`);return D},o);let l=[],c;if(i)try{c=i.urlBuilder(e),l=await F(c,async u=>{const I=await u.json();return i.p(I)},{...o,timeout:15e3})}catch(u){g.error(`Failed to fetch historical ${a} data`,u)}const h=O(s,l);return h.src=[e],c&&h.src.push(c),h}catch(s){return g.error(`Failed to fetch ${a} data:`,s),n??Y()}}function O(r,e=[]){const t=typeof r=="number"?{current:r}:r,n=e.length>0?T(e):"avg"in t?t.avg:void 0;return{...t,avg:n,updated:new Date}}function T(r){return parseFloat((r.reduce((e,t)=>e+t,0)/r.length).toFixed(2))}function Y(){return{current:0,updated:new Date}}d.getInstance();async function j(r){const e=new Date,t=new Date(e);t.setFullYear(e.getFullYear()-1);const n=new Date(e);return n.setFullYear(e.getFullYear()-5),W({url:`https://api.bcb.gov.br/dados/serie/bcdata.sgs.226/dados?formato=json&dataInicial=${w(t)}&dataFinal=${w(e)}`,p:a=>{if(!Array.isArray(a)||a.length<200)return null;const o=(a.reduce((i,s)=>i*(1+p(s.valor)/100),1)-1)*100;return p(o.toFixed(2))},fb:r,iname:"TR",hCfg:{urlBuilder:()=>`https://api.bcb.gov.br/dados/serie/bcdata.sgs.226/dados?formato=json&dataInicial=${w(n)}&dataFinal=${w(e)}`,p:a=>{if(!Array.isArray(a))return[];const o={};return a.forEach(i=>{const s=new Date(i.data).getFullYear();o[s]||(o[s]=[]),o[s].push(i)}),Object.entries(o).filter(([i,s])=>s.length>=200).map(([i,s])=>{const l=s.reduce((c,h)=>c*(1+p(h.valor)/100),1);return p(((l-1)*100).toFixed(2))})}},fOpt:{retries:3,retryDelay:1e3,timeout:15e3}})}const E=30*60*1e3,k={retries:7,retryDelay:1500,timeout:1e3},R={tr:j},y="economic_indices_data";async function m(){const{default:r}=await import("fs/promises"),{default:e}=await import("path");return{fs:r,path:e}}function $(r){let e=new Date(0);return Object.values(r).forEach(t=>{t?.updated instanceof Date&&t.updated>e&&(e=t.updated)}),e}async function C(){try{if(typeof window<"u"&&window.localStorage){const r=localStorage.getItem(y);return r?JSON.parse(r):null}else if(f()){const{fs:r,path:e}=await m(),t=e.join(process.cwd(),"indices.json");try{const n=await r.readFile(t,"utf-8");return JSON.parse(n)}catch(n){if(n.code==="ENOENT")return null;throw n}}return null}catch(r){return console.error("Failed to load from storage:",r),null}}async function v(r){try{const e=$(r),t={indices:r,updated:e.toISOString()};if(typeof window<"u"&&window.localStorage)localStorage.setItem(y,JSON.stringify(t));else if(f()){const{fs:n,path:a}=await m();console.log(process.cwd());const o=a.join(process.cwd(),"indices.json");await n.writeFile(o,JSON.stringify(t,null,2))}}catch(e){console.error("Failed to save to storage:",e)}}function X(r){if(!r)return!0;const e=new Date(r.updated),t=new Date;return e.getDate()!==t.getDate()||e.getMonth()!==t.getMonth()||e.getFullYear()!==t.getFullYear()}async function z(){try{if(typeof window<"u"&&window.localStorage)localStorage.removeItem(y);else if(f()){const{fs:r,path:e}=await m(),t=e.join(process.cwd(),"indices.json");try{await r.unlink(t)}catch(n){if(n.code!=="ENOENT")throw n}}}catch(r){throw console.error("Failed to clear storage:",r),r}}const B="data:text/javascript;base64,aW1wb3J0e0VDT05JRFggYXMgb31mcm9tIi4vRWNvbm9taWNJbmRpY2VzQ2xpZW50LmpzIjtpbXBvcnR7bG9hZEZyb21TdG9yYWdlIGFzIHMsZGV2ZXJpYUF0dWFsaXphciBhcyBhfWZyb20iLi9zdG9yYWdlLmpzIjtzZWxmLmE9YXN5bmMgcj0+e2lmKHIudC5lPT09InVwZGF0ZSIpdHJ5e2NvbnN0IGU9YXdhaXQgby5vKCk7c2VsZi5yKHtlOiJpbmRpY2VzIixzOmV9KX1jYXRjaChlKXtzZWxmLnIoe2U6ImVycm9yIixpOmUgaW5zdGFuY2VvZiBFcnJvcj9lLm46IlVua25vd24gZXJyb3IifSl9fTsoYXN5bmMoKT0+e2NvbnN0IHI9YXdhaXQgcygpO2lmKCFyfHxhKHIpKXtjb25zdCBlPWF3YWl0IG8ubygpO2UmJnNlbGYucih7ZToiaW5kaWNlcyIsczplfSl9fSkoKTsK";class P{constructor(){this.worker=null,this.currentIndices=null,this.pendingResolvers=[],this.isNode=typeof process<"u"&&process.versions?.node!==void 0,this.initialize().catch(console.error)}async initialize(){this.isNode||await this.initWebWorker()}async initWebWorker(){if(!(typeof Worker>"u"))try{const e=new Blob([B],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(e)),this.worker.onmessage=t=>{t.data.type==="indices"&&this.handleNewIndices(t.data.indices)},this.worker.onerror=t=>{console.error("Worker error:",t),this.handleWorkerError()}}catch(e){console.error("Worker initialization failed:",e)}}handleNewIndices(e){this.currentIndices=e,e&&v(e).catch(console.error),this.resolvePendingPromises(e)}handleWorkerError(){this.resolvePendingPromises(null)}resolvePendingPromises(e){this.pendingResolvers.forEach(t=>t(e)),this.pendingResolvers=[]}async getIndices(){const e=await C();return e&&!X(e)?e.indices:this.isNode?this.fetchIndicesNode():this.fetchIndicesBrowser()}async fetchIndicesNode(){try{const e=await this.fetchAll(this.currentIndices);return e&&(await v(e),this.currentIndices=e),e}catch(e){return console.error("Node fetch failed:",e),null}}async fetchIndicesBrowser(){return this.worker?new Promise(e=>{this.pendingResolvers.push(e),this.worker?.postMessage({type:"update"})}):this.fetchIndicesNode()}async fetchAll(e){const t={};return await Promise.all(Object.entries(R).map(async([n,a])=>{const o=n;t[o]=await a(e?.[o])})),t}}const N=new P;typeof window<"u"&&(window.ECONIDX=N,window.clearIndices=async()=>{await z().catch(r=>{console.error("Erro ao limpar storage:",r)})}),f()&&N.getIndices()})();
