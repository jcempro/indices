(function(){"use strict";function h(){return typeof process<"u"&&process.versions?.node!==void 0}const I=new Map;function N(r){const e=new Date;e.setFullYear(e.getFullYear()-r);const t=String(e.getDate()).padStart(2,"0"),n=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear();return`${t}/${n}/${o}`}class d{constructor(){this.enabled=!0}static getInstance(){return d.instance||(d.instance=new d),d.instance}log(e,t){this.enabled&&console.log(`[EconomicIndices] ${e}`,t||"")}error(e,t){this.enabled&&(new Date().toISOString(),console.error(`[EconomicIndices] ERROR: ${e}`,t||""))}enable(){this.enabled=!0}disable(){this.enabled=!1}}async function F(r,e,t={retries:3,retryDelay:1e3,timeout:8e3}){const n=I.get(r);if(n&&Date.now()-n.timestamp<A)return console.log(`[Cache hit] ${r}`),n.data;let o;for(let a=1;a<=t.retries;a++)try{const s=new AbortController,i=setTimeout(()=>s.abort(),t.timeout),c=await fetch(r,{signal:s.signal});if(clearTimeout(i),!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const l=await e(c);return I.set(r,{data:l,timestamp:Date.now()}),l}catch(s){o=s,a<t.retries&&await new Promise(i=>setTimeout(i,t.retryDelay))}throw o||new Error(`Failed after ${t.retries} retries`)}function w(r){return u((Math.pow(1+r/100,252)-1)*100+"")}function u(r){return parseFloat(parseFloat(`${r}`.replace(",",".")).toFixed(2))}function p(r){const e=new Date;return e.setFullYear(e.getFullYear()-r),`${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}`}const y=d.getInstance();async function f(r){const{url:e,p:t,fb:n,iname:o,fOpt:a=P,hCfg:s}=r;try{y.log(`> '${o}'`,e);const i=await F(e,async l=>{if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const v=await l.json(),g=t(v);if(g==null)throw new Error(`Invalid ${o} data structure`);return g},a);let c=[];if(s)try{const l=s.urlBuilder(e);c=await F(l,async v=>{const g=await v.json();return s.p(g)},{...a,timeout:15e3})}catch(l){y.error(`Failed to fetch historical ${o} data`,l)}return O(i,c)}catch(i){return y.error(`Failed to fetch ${o} data:`,i),n??E()}}function O(r,e=[]){const t=typeof r=="number"?{current:r}:r,n=e.length>0?W(e):"avg"in t?t.avg:void 0;return{...t,avg:n,updated:new Date}}function W(r){return parseFloat((r.reduce((e,t)=>e+t,0)/r.length).toFixed(2))}function E(){return{current:0,updated:new Date}}async function $(r){return f({url:"https://api.bcb.gov.br/dados/serie/bcdata.sgs.12/dados/ultimos/1?formato=json",p:e=>{if(!Array.isArray(e)||e.length===0)return null;const t=u(e[0].valor);return w(t)},fb:r?{...r,current:r.current?w(r.current):0}:void 0,iname:"CDI",hCfg:{urlBuilder:e=>e.replace("/ultimos/1","")+"&dataInicial="+N(5),p:e=>Array.isArray(e)?e.map(t=>{const n=u(t.valor);return w(n)}):[]}})}function S(r){return r.length===0?0:(r.reduce((e,t)=>e*(1+t/100),1)-1)*100}async function k(r){const e=p(5),t=p(1);return f({url:`https://apisidra.ibge.gov.br/values/t/1737/n1/all/v/63/p/${e}-${t}?formato=json`,p:n=>{if(!Array.isArray(n)||n.length<13)return null;const o=n.slice(-12).map(a=>u(a.V));return parseFloat(S(o).toFixed(2))},fb:r,iname:"INPC",hCfg:{urlBuilder:()=>`https://apisidra.ibge.gov.br/values/t/1737/n1/all/v/63/p/${e}-${t}?formato=json`,p:n=>{if(!Array.isArray(n)||n.length<2)return[];const o=n.slice(1),a=[],s={};return o.forEach(i=>{const c=i.D4N.split(" ")[1],l=u(i.V);s[c]||(s[c]=[]),s[c].push(l)}),Object.keys(s).forEach(i=>{const c=s[i];c.length===12&&a.push(S(c))}),a}}})}function j(r,e){return(r-e)/e*100}async function T(r){const e=p(5),t=p(1);return f({url:"https://servicodados.ibge.gov.br/api/v3/agregados/1737/periodos/-12/variaveis/2266?localidades=N1[all]",p:n=>{const o=n?.[0]?.resultados?.[0]?.series?.[0]?.serie;if(!o||Object.keys(o).length<12)return null;const a=Object.keys(o).sort(),s=a[0],i=a[a.length-1],c=u(o[s]),l=u(o[i]);return u(j(l,c))},fb:r,iname:"IPCA",hCfg:{urlBuilder:()=>`https://servicodados.ibge.gov.br/api/v3/agregados/1737/periodos/${e}-${t}/variaveis/2266?localidades=N1[all]`,p:n=>{const o=n?.[0]?.resultados?.[0]?.series?.[0]?.serie;if(!o)return[];const a=Object.keys(o).sort(),s=[];for(let i=12;i<a.length;i+=12){const c=u(o[a[i]]),l=u(o[a[i-12]]);s.push(j(c,l))}return s}}})}async function Y(r){const e=`https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados?formato=json&dataInicial=${N(5)}`;return f({url:"https://api.bcb.gov.br/dados/serie/bcdata.sgs.432/dados/ultimos/1?formato=json",p:t=>t?.length?u(t[0].valor):null,fb:r,iname:"SELIC",hCfg:{urlBuilder:()=>e,p:t=>Array.isArray(t)?t.map(n=>u(n.valor)):[]}})}const A=30*60*1e3,P={retries:7,retryDelay:1500,timeout:1e3},R={Selic:Y,CDI:$,ipca:T,inpc:k},m="economic_indices_data";async function b(){const{default:r}=await import("fs/promises"),{default:e}=await import("path");return{fs:r,path:e}}function X(r){let e=new Date(0);return Object.values(r).forEach(t=>{t?.updated instanceof Date&&t.updated>e&&(e=t.updated)}),e}async function z(){try{if(typeof window<"u"&&window.localStorage){const r=localStorage.getItem(m);return r?JSON.parse(r):null}else if(h()){const{fs:r,path:e}=await b(),t=e.join(process.cwd(),"indices.json");try{const n=await r.readFile(t,"utf-8");return JSON.parse(n)}catch(n){if(n.code==="ENOENT")return null;throw n}}return null}catch(r){return console.error("Failed to load from storage:",r),null}}async function C(r){try{const e=X(r),t={indices:r,updated:e.toISOString()};if(typeof window<"u"&&window.localStorage)localStorage.setItem(m,JSON.stringify(t));else if(h()){const{fs:n,path:o}=await b();console.log(process.cwd());const a=o.join(process.cwd(),"indices.json");await n.writeFile(a,JSON.stringify(t,null,2))}}catch(e){console.error("Failed to save to storage:",e)}}function B(r){if(!r)return!0;const e=new Date(r.updated),t=new Date;return e.getDate()!==t.getDate()||e.getMonth()!==t.getMonth()||e.getFullYear()!==t.getFullYear()}async function V(){try{if(typeof window<"u"&&window.localStorage)localStorage.removeItem(m);else if(h()){const{fs:r,path:e}=await b(),t=e.join(process.cwd(),"indices.json");try{await r.unlink(t)}catch(n){if(n.code!=="ENOENT")throw n}}}catch(r){throw console.error("Failed to clear storage:",r),r}}const Z="data:text/javascript;base64,aW1wb3J0e0VDT05JRFggYXMgb31mcm9tIi4vRWNvbm9taWNJbmRpY2VzQ2xpZW50LmpzIjtpbXBvcnR7bG9hZEZyb21TdG9yYWdlIGFzIHMsZGV2ZXJpYUF0dWFsaXphciBhcyBhfWZyb20iLi9zdG9yYWdlLmpzIjtzZWxmLmE9YXN5bmMgcj0+e2lmKHIudC5lPT09InVwZGF0ZSIpdHJ5e2NvbnN0IGU9YXdhaXQgby5vKCk7c2VsZi5yKHtlOiJpbmRpY2VzIixzOmV9KX1jYXRjaChlKXtzZWxmLnIoe2U6ImVycm9yIixpOmUgaW5zdGFuY2VvZiBFcnJvcj9lLm46IlVua25vd24gZXJyb3IifSl9fTsoYXN5bmMoKT0+e2NvbnN0IHI9YXdhaXQgcygpO2lmKCFyfHxhKHIpKXtjb25zdCBlPWF3YWl0IG8ubygpO2UmJnNlbGYucih7ZToiaW5kaWNlcyIsczplfSl9fSkoKTsK";class J{constructor(){this.worker=null,this.currentIndices=null,this.pendingResolvers=[],this.isNode=typeof process<"u"&&process.versions?.node!==void 0,this.initialize().catch(console.error)}async initialize(){this.isNode||await this.initWebWorker()}async initWebWorker(){if(!(typeof Worker>"u"))try{const e=new Blob([Z],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(e)),this.worker.onmessage=t=>{t.data.type==="indices"&&this.handleNewIndices(t.data.indices)},this.worker.onerror=t=>{console.error("Worker error:",t),this.handleWorkerError()}}catch(e){console.error("Worker initialization failed:",e)}}handleNewIndices(e){this.currentIndices=e,e&&C(e).catch(console.error),this.resolvePendingPromises(e)}handleWorkerError(){this.resolvePendingPromises(null)}resolvePendingPromises(e){this.pendingResolvers.forEach(t=>t(e)),this.pendingResolvers=[]}async getIndices(){const e=await z();return e&&!B(e)?e.indices:this.isNode?this.fetchIndicesNode():this.fetchIndicesBrowser()}async fetchIndicesNode(){try{const e=await this.fetchAll(this.currentIndices);return e&&(await C(e),this.currentIndices=e),e}catch(e){return console.error("Node fetch failed:",e),null}}async fetchIndicesBrowser(){return this.worker?new Promise(e=>{this.pendingResolvers.push(e),this.worker?.postMessage({type:"update"})}):this.fetchIndicesNode()}async fetchAll(e){const t={};return await Promise.all(Object.entries(R).map(async([n,o])=>{const a=n;t[a]=await o(e?.[a])})),t}}const D=new J;typeof window<"u"&&(window.ECONIDX=D,window.clearIndices=V),h()&&D.getIndices()})();
